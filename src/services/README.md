# index.ts

The `index.ts` file within the `src/services` directory of the `ferrumnet/multiswap-node` repository serves as a central point for exporting modules. This file essentially organizes and makes accessible the defined modules in the project for periodic tasks.

# axios.service.ts

### Function: `getTransactions`

Purpose:\
Fetches a list of transactions from the Multiswap backend with a specific status, limit, and node type. The function also considers the running environment to adjust the API endpoint accordingly.

Parameters:\
None.

Returns:

-   `Array` of transactions if the request is successful.
-   `null` if an error occurs during the request.

Details:

1.  Determines the base URL based on the environment. If it's a local environment, it uses a local URL. Otherwise, it uses the URL from the environment variable `GATEWAY_BACKEND_URL`.
2.  Configures the request headers to include authorization generated by the `createAuthTokenForMultiswapBackend` function.
3.  Constructs a URL with query parameters including status, limit, node type, and a public key.
4.  Makes a GET request to the constructed URL and returns the transactions if successful or `null` if an error occurs.

Example Use:

javascript

Copy code

`getTransactions().then(transactions => {
  console.log(transactions);
}).catch(error => {
  console.error("Failed to fetch transactions:", error);
});`

### Function: `updateTransaction`

Purpose:\
Updates a transaction status on the Multiswap backend. This function is especially useful for handling transaction validations.

Parameters:

-   `txHash` (string): The transaction hash to identify the transaction to be updated.
-   `body` (any): The body of the request containing the updated transaction details.
-   `isValidationFailed` (boolean): A flag indicating whether the validation failed.

Returns:\
The response from the axios PUT request, which will typically be a success or error message from the backend.

Details:

1.  Similar to `getTransactions`, it sets the base URL based on the environment.
2.  Constructs headers with authorization as done in `getTransactions`.
3.  Builds the URL with query parameters to include the transaction hash, public key, and validation failure status.
4.  Sends a PUT request to the backend with the body and configuration, and returns the response.

Example Use:

javascript

Copy code

`const transactionBody = { /* transaction details here */ };
updateTransaction("tx12345", transactionBody, false).then(response => {
  console.log("Transaction updated:", response);
}).catch(error => {
  console.error("Error updating transaction:", error);
});`

These functions are part of the `axios.service.ts` module, designed to interact with the Multiswap backend API, handling both fetching and updating transaction data based on the application's needs.

# signature.service.ts

### 1\. `getDataForSignature(job: any): Promise<any>`

This function constructs transaction data suitable for signature based on the job's details and decoded signature data. It integrates with services to fetch necessary addresses and computes the transaction data which includes from address, token, amount, contract addresses, chain IDs, signatures, salt, asset types, amounts in/out, and expiry data.

### 2\. `getValidWithdrawalData(data: any, decodedData: any): Promise<any>`

Extracts valid withdrawal data from a transaction by verifying its integrity against the latest transaction hash and settled amount criteria. It ensures that the data provided is still valid and hasn't been tampered with or outdated.

### 3\. `isValidSettledAmount(slippage: number, sourceChainId: string, destinationChainId: string, destinationAmountIn: any, settledAmount: any): Promise<boolean>`

Calculates whether the settled amount is valid based on the slippage parameters and chain IDs. It checks if the settled amount meets or exceeds the expected amount after accounting for slippage.

### 4\. `createSignedPayment(...)`

Generates a signed payment, crafting a hash of the transaction details and then signing it using the private key. The specifics of the hash depend on the asset type involved (either `FOUNDARY` or `ONE_INCH`).

### 5\. `produceFoundaryHash(...)`

Produces a hash specific to `FOUNDARY` type transactions by serializing and hashing transaction details. It uses the Ethereum standard EIP712 for structured data hashing and signing.

### 6\. `produceOneInchHash(...)`

Produces a hash for `ONE_INCH` type transactions. Similar to `produceFoundaryHash`, but specific to the OneInch exchange transactions involving additional parameters such as `amountIn` and `amountOut`.

### 7\. `domainSeparator(web3: Web3, chainId: string, contractAddress: string)`

Generates a domain separator which is a unique hash for a set of transactions from a specific contract on a given chain, used to prevent certain types of replay attacks in different environments.

### 8\. `validateSignature(job: any, localSignatures: any): Promise<boolean>`

Validates a set of signatures against expected transaction details. It ensures all provided signatures are valid and correspond to the address they claim to represent.

### 9\. `isRecoverAddressValid(signature: string, hash: string, publicAddress: string): boolean`

Checks if the recovered address from a signature matches the provided public address. It is a security check to ensure the signer of a transaction is the claimant of the transaction.

### 10\. `getDataForSalt(hash: string, txData: any, decodedData: any): string`

Generates a unique salt string from transaction and decoded data, ensuring uniqueness and preventing replay attacks.

### 11\. `getDecodedLogsDataIntoString(decodedData: any): string`

Helper function to serialize decoded log data into a string format, used for generating hashes or for logging purposes.

These functions together provide a robust suite for managing blockchain transactions and their security, particularly focused on signature verification and data integrity in a decentralized environment.

# transaction.service.ts

### Function: `prepareObjectsAndVerifySignatures(tx: any)`

This function prepares the necessary data objects from a transaction `tx` and verifies signatures. It organizes transaction information into two structured objects, `JobRequestBody` and `SignatureData`, and a combined object `job`. After assembling the data, it calls `verifySignatures` to handle the signature verification.

-   Parameters:
    -   `tx`: The transaction object containing various transaction details.
-   Operations:
    -   Extract and structure transaction data.
    -   Call `verifySignatures` with the assembled job data.

### Function: `verifySignatures(job: any)`

Verifies the signatures associated with a job. It handles the logic to verify signatures based on whether the destination is a non-EVM (Ethereum Virtual Machine) network or not. If verification fails, it updates the transaction status as failed.

-   Parameters:
    -   `job`: A job object containing transaction and signature data.
-   Operations:
    -   Conditional checks for EVM and non-EVM transactions.
    -   Signature validation and transaction updates based on the outcome.

### Function: `createWithdrawalSignature(job: any)`

Creates a withdrawal signature for a transaction job. It decides the process based on whether the destination is a non-EVM network or not, and updates the transaction accordingly.

-   Parameters:
    -   `job`: A job object that includes data necessary for generating a signature.
-   Operations:
    -   Transaction signature creation and update based on network type.

### Function: `updateTransaction(txId: string, signedData: any, isValidationFailed: boolean)`

Updates a transaction in the database with the new signed data or flags it as failed based on the validation results. Also removes the transaction hash from the local list after updating.

-   Parameters:
    -   `txId`: Transaction ID to update.
    -   `signedData`: Signed data for the transaction.
    -   `isValidationFailed`: A boolean indicating if the signature validation failed.
-   Operations:
    -   Update the transaction in the database and handle local list cleanup.

### Function: `getGeneratorHash(tx: any): string`

Extracts and returns the hash from the generator signatures of a transaction. Handles errors gracefully.

-   Parameters:
    -   `tx`: The transaction object that might contain generator signatures.
-   Returns:
    -   The hash string extracted from the first signature or an empty string if not available or on error.

Each function is designed to handle specific aspects of transaction processing and signature management, contributing to the transaction workflow in a blockchain network environment.

# web3.service.ts

1.  getTransactionReceipt:

    -   Purpose: Asynchronously retrieves a transaction receipt for a given transaction ID and chain ID.
    -   Parameters:
        -   `txId`: The transaction ID as a string.
        -   `chainId`: The blockchain chain ID as a string.
        -   `threshold`: The maximum number of retries for fetching the transaction receipt.
        -   `tries`: (Optional) Current number of attempts, defaults to 0.
    -   Returns: A promise that resolves to a `TransactionReceipt` object.
    -   Description: This function attempts to fetch the transaction receipt from the blockchain. If the transaction or its status is not available, it delays and retries until the threshold is met.
2.  getTransactionByHash:

    -   Purpose: Fetches a transaction from the blockchain using its hash.
    -   Parameters:
        -   `txHash`: The hash of the transaction.
        -   `chainId`: The chain ID of the blockchain.
    -   Returns: A promise that resolves to a `Transaction` object.
3.  signedTransaction:

    -   Purpose: Processes and signs a transaction based on provided job details and hash.
    -   Parameters:
        -   `job`: An object containing details about the job.
        -   `hash`: A string representing the hash for which the signature is to be created.
    -   Returns: A promise that resolves to an object containing transaction details and signatures.
    -   Description: This function handles the process of signing a transaction, including preparing the data for signing, creating the signature, and returning the signed transaction details.
4.  getFundManagerAddress:

    -   Purpose: Retrieves the fund manager address for a given chain ID.
    -   Parameters:
        -   `chainId`: The chain ID to lookup.
    -   Returns: A string representing the fund manager's address.
    -   Description: Looks up the fund manager address from a predefined list of networks based on the chain ID.
5.  getFiberRouterAddress:

    -   Purpose: Retrieves the fiber router address for a given chain ID.
    -   Parameters:
        -   `chainId`: The chain ID to lookup.
    -   Returns: A string representing the fiber router's address.
    -   Description: Looks up the fiber router address from a predefined list of networks based on the chain ID.
6.  getFoundaryTokenAddress:

    -   Purpose: Retrieves the foundary token address for a specific target chain ID.
    -   Parameters:
        -   `targetChainId`: The target chain ID for which the token address is needed.
    -   Returns: A string representing the foundary token's address.
    -   Description: Searches through a predefined list of networks to find and return the foundary token address corresponding to the target chain ID.
7.  getDestinationAmount:

    -   Purpose: Asynchronously calculates the destination amount based on input data.
    -   Parameters:
        -   `data`: An object containing the swap bridge amount.
    -   Returns: A promise that resolves to the swap bridge amount.